generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ServiceRequest {
  id               String     @id @default(cuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  customerName     String
  address          String
  serviceNumber    String?
  phone            String?
  receivedAt       DateTime?
  receivedBy       String?
  handledAt        DateTime?
  handlerName      String?
  inspectedAt      DateTime?
  inspectorName    String?
  reasons          Json?
  otherReason      String?
  actionTaken      String?
  serviceCostBy    String?
  handoverReceiver String?
  handoverCustomer String?
  handoverAt       DateTime?
  reporterName     String?
  reporterPhone    String?
  description      String?    @db.Text
  urgency          Urgency    @default(MEDIUM)
  requestDate      DateTime   @default(now())
  notes            String?    @db.Text
  complaint        Complaint? @relation("ComplaintToServiceRequest")
  workOrder        WorkOrder?

  @@index([createdAt])
  @@index([customerName])
  @@index([serviceNumber])
  @@index([reporterName])
  @@index([requestDate])
  @@index([urgency])
}

model WorkOrder {
  id                  String          @id @default(cuid())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  reportDate          DateTime?
  number              String?
  handledDate         DateTime?
  reporterName        String?
  handlingTime        String?
  disturbanceLocation String?
  disturbanceType     String?
  city                String?
  cityDate            DateTime?
  executorName        String?
  team                String?
  technicians         String?
  scheduledDate       DateTime?
  instructions        String?         @db.Text
  serviceRequestId    String?         @unique
  creatorSignature    String?         @db.Text
  creatorSignedAt     DateTime?
  creatorSignedBy     String?
  supervisorSignature String?         @db.Text
  supervisorSignedAt  DateTime?
  supervisorSignedBy  String?
  complaint           Complaint?      @relation("ComplaintToWorkOrder")
  repairReport        RepairReport?
  serviceRequest      ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@index([createdAt])
  @@index([number])
  @@index([disturbanceLocation])
  @@index([team])
  @@index([scheduledDate])
}

model RepairReport {
  id                       String        @id @default(cuid())
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  actionTaken              String?       @db.Text
  startTime                DateTime?
  endTime                  DateTime?
  result                   RepairResult?
  remarks                  String?       @db.Text
  customerConfirmationName String?
  actions                  Json?
  otherActions             String?
  notHandledReasons        Json?
  otherNotHandled          String?
  city                     String?
  cityDate                 DateTime?
  executorName             String?
  team                     String?
  authorizedBy             String?
  workOrderId              String?       @unique
  complaint                Complaint?    @relation("ComplaintToRepairReport")
  workOrder                WorkOrder?    @relation(fields: [workOrderId], references: [id])

  @@index([createdAt])
  @@index([result])
  @@index([startTime])
  @@index([endTime])
}

model Complaint {
  id               String          @id @default(cuid())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  customerName     String
  address          String          @db.Text
  mapsLink         String?         @db.VarChar(512)
  connectionNumber String?
  phone            String?
  complaintText    String          @db.Text
  category         String
  processedAt      DateTime?
  status           CaseStatus      @default(REPORTED)
  serviceRequestId String?         @unique
  workOrderId      String?         @unique
  repairReportId   String?         @unique
  repairReport     RepairReport?   @relation("ComplaintToRepairReport", fields: [repairReportId], references: [id])
  serviceRequest   ServiceRequest? @relation("ComplaintToServiceRequest", fields: [serviceRequestId], references: [id])
  workOrder        WorkOrder?      @relation("ComplaintToWorkOrder", fields: [workOrderId], references: [id])
  histories        StatusHistory[]

  @@index([createdAt])
  @@index([status, createdAt])
  @@index([customerName])
  @@index([connectionNumber])
  @@index([category])
  @@index([phone])
}

model StatusHistory {
  id          String     @id @default(cuid())
  createdAt   DateTime   @default(now())
  complaintId String
  status      CaseStatus
  note        String?    @db.Text
  actorRole   String
  actorId     String?
  complaint   Complaint  @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId, createdAt])
}

enum CaseStatus {
  REPORTED
  PSP_CREATED
  SPK_CREATED
  RR_CREATED
  COMPLETED
  MONITORING
}

enum RepairResult {
  FIXED
  MONITORING
  NOT_FIXED
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
}
